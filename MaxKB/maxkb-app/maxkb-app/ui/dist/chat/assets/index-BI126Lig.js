import{bk as We,c_ as Le,bj as ue,ay as Ie,aA as Re,b8 as Pe,b7 as C,aB as _,c$ as ae,bZ as ie,bY as V,b_ as w,c0 as z,br as Ae,aD as i,bf as Y,aF as u,aI as f,aH as d,aJ as R,aE as y,bm as Z,bn as P,bW as ce,aG as c,aK as K,bg as he,bh as be,d0 as $e,c1 as De,d1 as xe,ce as Se,bd as Ue,aC as X,be as Ve,bs as we,bX as re,bt as Ke,bo as ze}from"./chat-CUfIjAsy.js";import{l as Ge}from"./permission-api-DyNdOx42.js";import"./workspace-Cv2gXV-V.js";const oe="/workspace",Fe=(A,p,I,N,x)=>ue(`${oe}/${A}/user_resource_permission/user/${p}/resource/${I}`,N,x),je=(A,p,I,N,x)=>We(`${oe}/${A}/user_resource_permission/user/${p}/resource/${I}`,N,{},x),He=(A,p)=>ue(`${oe}/${A}/user_list`,void 0,p),Be=(A,p)=>ue(`${oe}/${A}/user_member`,void 0,p),Je=(A,p,I,N)=>p=="MODEL"?Promise.resolve(Le.success([{id:"default",name:"根目录",desc:null,parent_id:null,children:[]}])):ue(`${oe}/${A}/${p}/folder`,I,N),ge={getResourceAuthorization:Fe,putResourceAuthorization:je,getUserList:He,getUserMember:Be,getSystemFolder:Je},qe={class:"permission-setting p-24 flex"},Xe={class:"resource-authorization__table"},Ye={class:"mb-16"},Ze={class:"flex-between mb-16"},Qe={class:"flex-between complex-search"},et={style:{"vertical-align":"sub"}},tt=["src"],ot=["innerHTML"],st={class:"color-text-primary lighter"},lt={class:"dialog-footer mt-24"},nt=Ie({__name:"PermissionTable",props:{data:{},type:{},getData:{type:Function}},emits:["submitPermissions"],setup(A,{expose:p,emit:I}){const{model:N}=Re(),x=Pe(),h=A,G=I,F=C(()=>{var O,k;const e=S.value.name||"",t=S.value.permission??[];if(!e&&(!t||t.length===0))return((O=h.data)==null?void 0:O.length)>0?[(k=h.data[0])==null?void 0:k.id]:[];const l=[],m=T=>{T.forEach(a=>{a.children&&a.children.length>0&&(l.push(a.id),m(a.children))})};return m(D.value),l}),L=C(()=>({rootFolder:ae(!0,!0),folder:ae(!0,!1),resource:ae(!1,!1)})),Q=e=>{const t=e.resource_type==="folder";return t&&e.folder_id===null?L.value.rootFolder:t?L.value.folder:L.value.resource},j=C(()=>E.value.some(e=>e.resource_type==="folder"&&e.folder_id==null)?L.value.rootFolder:E.value.some(e=>e.resource_type==="folder")?L.value.folder:L.value.resource),de=_({APPLICATION:new ie([V.ADMIN,V.WORKSPACE_MANAGE],[w.APPLICATION_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT,w.APPLICATION_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT.getWorkspacePermissionWorkspaceManageRole],[],"OR"),KNOWLEDGE:new ie([V.ADMIN,V.WORKSPACE_MANAGE],[w.KNOWLEDGE_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT,w.KNOWLEDGE_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT.getWorkspacePermissionWorkspaceManageRole],[],"OR"),TOOL:new ie([V.ADMIN,V.WORKSPACE_MANAGE],[w.TOOL_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT,w.TOOL_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT.getWorkspacePermissionWorkspaceManageRole],[],"OR"),MODEL:new ie([V.ADMIN,V.WORKSPACE_MANAGE],[w.MODEL_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT,w.MODEL_WORKSPACE_USER_RESOURCE_PERMISSION_EDIT.getWorkspacePermissionWorkspaceManageRole],[],"OR")}),se=C(()=>h.type===z.KNOWLEDGE),pe=C(()=>h.type===z.APPLICATION),me=C(()=>h.type===z.TOOL),U=C(()=>h.type===z.MODEL),B=_(),$=_("name"),S=_({name:"",permission:void 0}),le=()=>{S.value={name:"",permission:void 0}},ee=()=>{const e=S.value.name||"",t=S.value.permission??[];if(!e&&(!t||t.length===0))return h.data;const l=(m,O,k)=>{if(!m||m.length===0)return[];const T=[];for(const a of m){const J={...a};let q=!1;$.value==="name"?q=a.name.toLowerCase().includes(O.toLowerCase()):$.value==="permission"&&(q=a.permission&&k.includes(a.permission));let te=[];a.children&&a.children.length>0&&(te=l(a.children,O,k)),(q||te.length>0)&&(J.children=te,T.push(J))}return T};return l(h.data,e,t)},D=C(()=>ee()),E=_([]),H={},_e=e=>{E.value=e},s=(e,t)=>{t.resource_type==="folder"?e.some(l=>l.id==t.id)?E.value=e:(H[t.id]===void 0&&(H[t.id]=0),H[t.id]%2==0?(xe([t]).filter(l=>l.id!=t.id).forEach(l=>{var m;E.value.some(O=>l.id==O.id)&&((m=B.value)==null||m.toggleRowSelection(l,!0))}),E.value=B.value.getSelectionRows()):E.value=e,H[t.id]=H[t.id]+1):E.value=e},n=_(!1),r=_("");function M(){E.value.length!==0&&(n.value=!0)}function b(){if(E.value.length===0||!r.value)return;const e=E.value.map(t=>({target_id:t.id,permission:r.value}));G("submitPermissions",e),v()}function v(){var e;n.value=!1,r.value="",E.value=[],(e=B.value)==null||e.clearSelection()}function g(e,t){const l=[{target_id:t.id,permission:e}],m=(O,k,T)=>{if(!O||O.length===0)return[];for(const a of O){const J=a.permission=="NOT_AUTH"&&k.includes(a.id);a.children&&a.children.length>0&&!J&&m(a.children,k,T),a.permission=="NOT_AUTH"&&k.includes(a.id)&&(k.push(a.folder_id),T.push({target_id:a.id,permission:"VIEW"}))}return T};["VIEW","MANAGE","ROLE"].includes(e)&&m(h.data,[t.folder_id],l),G("submitPermissions",l)}const ne=_([]);function fe(){N.asyncGetProvider().then(e=>{ne.value=e==null?void 0:e.data})}const ve=C(()=>e=>{var t;return(t=ne.value.find(l=>l.provider===e.icon))==null?void 0:t.icon});return Ae(()=>{U.value&&fe()}),p({searchForm:S,searchType:$}),(e,t)=>{var Oe;const l=i("el-button"),m=i("el-option"),O=i("el-select"),k=i("el-input"),T=i("el-table-column"),a=i("AppIcon"),J=i("KnowledgeIcon"),q=i("el-avatar"),te=i("LogoIcon"),ke=i("ToolIcon"),Ee=i("el-radio"),ye=i("el-radio-group"),Te=i("app-table"),Ce=i("el-text"),Ne=i("el-dialog");return u(),Y("div",qe,[f("div",Xe,[f("h4",Ye,R(e.$t("views.system.resourceAuthorization.permissionSetting")),1),f("div",Ze,[P(ce)(de.value[((Oe=P(x).meta)==null?void 0:Oe.resource)||"APPLICATION"],"OR")?(u(),y(l,{key:0,type:"primary",disabled:E.value.length===0,onClick:M},{default:c(()=>[K(R(e.$t("views.system.resourceAuthorization.setting.configure")),1)]),_:1},8,["disabled"])):Z("",!0),f("div",Qe,[d(O,{class:"complex-search__left",modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=o=>$.value=o),style:{width:"80px"},onChange:le},{default:c(()=>[d(m,{label:e.$t("common.name"),value:"name"},null,8,["label"]),d(m,{label:e.$t("views.model.modelForm.permissionType.label"),value:"permission"},null,8,["label"])]),_:1},8,["modelValue"]),$.value==="name"?(u(),y(k,{key:0,modelValue:S.value.name,"onUpdate:modelValue":t[1]||(t[1]=o=>S.value.name=o),placeholder:e.$t("common.searchBar.placeholder"),style:{width:"220px"},clearable:""},null,8,["modelValue","placeholder"])):$.value==="permission"?(u(),y(O,{key:1,modelValue:S.value.permission,"onUpdate:modelValue":t[2]||(t[2]=o=>S.value.permission=o),filterable:"",clearable:"",multiple:"","reserve-keyword":!1,"collapse-tags":"","collapse-tags-tooltip":"",style:{width:"220px"}},{default:c(()=>[(u(!0),Y(he,null,be(P(ae)(),(o,W)=>(u(),y(m,{key:W,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):Z("",!0)])]),d(Te,{ref_key:"multipleTableRef",ref:B,class:"mt-16",data:D.value,onSelect:s,onSelectAll:_e,maxTableHeight:260,"row-key":o=>o.id,style:{"min-width":"600px"},"expand-row-keys":F.value,"show-overflow-tooltip":""},{default:c(()=>[d(T,{type:"selection",width:"55","reserve-selection":!0}),d(T,{prop:"name",label:e.$t("common.name")},{default:c(({row:o})=>[f("span",et,[o.resource_type==="folder"?(u(),y(a,{key:0,iconName:"app-folder",style:{"font-size":"20px"}})):se.value?(u(),y(J,{key:1,size:20,type:o.icon},null,8,["type"])):P($e)(o==null?void 0:o.icon)&&!U.value?(u(),y(q,{key:2,style:{background:"none"},shape:"square",size:20},{default:c(()=>[f("img",{src:P(De)(o==null?void 0:o.icon),alt:""},null,8,tt)]),_:2},1024)):pe.value?(u(),y(te,{key:3,height:"20px"})):me.value?(u(),y(ke,{key:4,size:20,type:o==null?void 0:o.tool_type},null,8,["type"])):U.value?(u(),Y("span",{key:5,style:{width:"20px",height:"20px",display:"inline-block"},innerHTML:ve.value(o)},null,8,ot)):Z("",!0)]),K(" "+R(o==null?void 0:o.name),1)]),_:1},8,["label"]),d(T,{label:e.$t("views.model.modelForm.permissionType.label"),align:"left"},{default:c(({row:o})=>[d(ye,{modelValue:o.permission,"onUpdate:modelValue":W=>o.permission=W,onChange:W=>g(W,o)},{default:c(()=>[(u(!0),Y(he,null,be(Q(o),(W,Me)=>(u(),y(Ee,{key:Me,value:W.value,class:"mr-16"},{default:c(()=>[K(R(W.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1},8,["label"])]),_:1},8,["data","row-key","expand-row-keys"])]),d(Ne,{modelValue:n.value,"onUpdate:modelValue":t[4]||(t[4]=o=>n.value=o),title:e.$t("views.system.resourceAuthorization.setting.configure"),"destroy-on-close":"",onClose:v},{footer:c(()=>[f("div",lt,[d(l,{onClick:v},{default:c(()=>[K(R(e.$t("common.cancel")),1)]),_:1}),d(l,{type:"primary",onClick:b},{default:c(()=>[K(R(e.$t("common.confirm")),1)]),_:1})])]),default:c(()=>[d(ye,{modelValue:r.value,"onUpdate:modelValue":t[3]||(t[3]=o=>r.value=o),class:"radio-block"},{default:c(()=>[(u(!0),Y(he,null,be(j.value,(o,W)=>(u(),y(Ee,{key:W,value:o.value,class:"mr-16"},{default:c(()=>[f("p",st,R(o.label),1),d(Ce,{class:"color-secondary lighter"},{default:c(()=>[K(R(o.desc),1)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])])}}}),at=Se(nt,[["__scopeId","data-v-97b633dc"]]),it={class:"resource-authorization p-16-24"},rt={class:"flex align-center mb-16"},ct={class:"ml-4 color-text-primary"},ut={class:"flex"},dt={class:"resource-authorization__left border-r"},pt={class:"p-24 pb-0"},mt={class:"mb-12"},_t={class:"list-height-left"},ft={class:"p-8-16"},vt={class:"flex-between"},ht={class:"flex"},bt=["title"],gt=Ie({__name:"index",setup(A){const p=Pe(),{user:I}=Re(),N=_(!1),x=_(!1),h=_([]),G=_([]),F=_(""),L=_(""),Q=_(""),j=_([]),de=Ue([{label:X("views.knowledge.title"),type:z.KNOWLEDGE},{label:X("views.application.title"),type:z.APPLICATION},{label:X("views.tool.title"),type:z.TOOL},{label:X("views.model.title"),type:z.MODEL}]),se=C(()=>{const s=p.path.lastIndexOf("/"),n=p.path.substring(s+1).toUpperCase();return de.filter(r=>r.type===n)[0]});Ve(Q,s=>{s?G.value=h.value.filter(n=>n.nick_name.toLowerCase().includes(s.toLowerCase())):G.value=h.value});function pe(s){var r;const n=D.value||I.getWorkspaceId()||"default";ge.putResourceAuthorization(n,F.value,((r=p.meta)==null?void 0:r.resource)||"APPLICATION",s,x).then(()=>{ze(X("common.submitSuccess")),U()})}const me=_(),U=()=>{var r;const s=D.value||I.getWorkspaceId()||"default",n={};ge.getResourceAuthorization(s,F.value,((r=p.meta)==null?void 0:r.resource)||"APPLICATION",n,x).then(M=>{var v;(((v=p.meta)==null?void 0:v.resource)||"APPLICATION")==="MODEL"?j.value=M.data||[]:j.value=M.data.map(g=>!g.folder_id&&g.permission==="NOT_AUTH"?{...g,permission:"VIEW"}:g)||[]})},B=(s,n)=>{if(!s||s.length===0)return[];const r=JSON.parse(JSON.stringify(s)),M=Object.fromEntries(r.map(b=>[b.id,b]));for(let b=0;b<s.length;b++){const v=r[b];if(v.children||(v.children=[]),v[n]){const g=M[v[n]];g&&(g.children||(g.children=[]),g.children.push(v))}}return r.filter(b=>!b[n])},$=C(()=>{var n;return(((n=p.meta)==null?void 0:n.resource)||"APPLICATION")==="MODEL"?j.value:B(j.value,"folder_id")});function S(s){F.value=s.id,L.value=s.type,U()}function le(s){const n=D.value||I.getWorkspaceId()||"default";ge.getUserMember(n,N).then(r=>{var M,b,v,g;h.value=r.data,G.value=r.data,h.value.length>0?(F.value=(b=(M=h.value)==null?void 0:M[0])==null?void 0:b.id,L.value=(g=(v=h.value)==null?void 0:v[0])==null?void 0:g.type,U()):j.value=[]})}const ee=_([]),D=_(""),E=C(()=>ee.value.find(s=>s.id==D.value));async function H(){const s=await Ge("workspace").getSystemWorkspaceList(N);ee.value=s.data,D.value=I.getWorkspaceId()||"default"}function _e(s){D.value=s.id,le()}return Ae(()=>{I.isEE()&&H(),le()}),(s,n)=>{const r=i("el-breadcrumb-item"),M=i("el-breadcrumb"),b=i("el-divider"),v=i("WorkspaceDropdown"),g=i("el-input"),ne=i("el-text"),fe=i("common-list"),ve=i("el-scrollbar"),e=i("el-card"),t=we("loading");return u(),Y("div",it,[f("div",rt,[d(M,{"separator-icon":"ArrowRight"},{default:c(()=>[d(r,null,{default:c(()=>[K(R(P(X)("views.system.resourceAuthorization.title")),1)]),_:1}),d(r,null,{default:c(()=>[f("h5",ct,R(se.value.label),1)]),_:1})]),_:1}),P(ce)(P(re).IS_EE,"OR")?(u(),y(b,{key:0,class:"ml-24",direction:"vertical"})):Z("",!0),P(ce)(P(re).IS_EE,"OR")?(u(),y(v,{key:1,data:ee.value,currentWorkspace:E.value,onChangeWorkspace:_e},null,8,["data","currentWorkspace"])):Z("",!0)]),d(e,{style:{"--el-card-padding":"0",height:"calc(100vh - 140px)"}},{default:c(()=>[f("div",ut,[f("div",dt,[f("div",pt,[f("h4",mt,R(s.$t("views.system.resourceAuthorization.member")),1),d(g,{modelValue:Q.value,"onUpdate:modelValue":n[0]||(n[0]=l=>Q.value=l),placeholder:s.$t("common.search"),"prefix-icon":"Search",clearable:""},null,8,["modelValue","placeholder"])]),f("div",_t,[d(ve,null,{default:c(()=>[f("div",ft,[Ke((u(),y(fe,{data:G.value,onClick:S,"default-active":F.value},{default:c(({row:l})=>[f("div",vt,[f("div",ht,[f("span",{class:"mr-8 ellipsis-1",title:l.nick_name},R(l.nick_name),9,bt),P(ce)([P(re).IS_EE,P(re).IS_PE],"OR")?(u(),y(ne,{key:0,class:"color-input-placeholder ellipsis-1",title:l.roles.join("，")},{default:c(()=>{var m;return[K("("+R((m=l.roles)==null?void 0:m.join("，"))+")",1)]}),_:2},1032,["title"])):Z("",!0)])])]),_:1},8,["data","default-active"])),[[t,N.value]])])]),_:1})])]),d(at,{data:$.value,type:se.value.type,ref_key:"PermissionTableRef",ref:me,getData:U,onSubmitPermissions:pe},null,8,["data","type"])])]),_:1})])}}}),It=Se(gt,[["__scopeId","data-v-67bc9bb0"]]);export{It as default};
