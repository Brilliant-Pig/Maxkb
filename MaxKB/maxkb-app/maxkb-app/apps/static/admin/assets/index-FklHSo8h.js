import{ay as oe,aA as se,aB as v,aO as ve,bF as ge,aU as ne,aC as i,aV as ie,aD as m,b7 as le,aE as $,aF as b,aG as n,aI as A,aH as l,aW as Y,b1 as D,b8 as ae,aJ as y,aS as T,b2 as p,aK as I,cM as re,cN as fe,cO as G,b3 as Q,b6 as be,bI as J,bK as Z,bZ as _e,bG as X,c0 as we}from"./admin-Ca7cl6NN.js";import{_ as he}from"./MemberFormContent.vue_vue_type_script_setup_true_lang-BkezDNsU.js";const ke={class:"title-decoration-1 mb-16 mt-8"},$e={key:0,class:"title-decoration-1 mb-16 mt-8"},Me=oe({__name:"UserDrawer",props:{title:String},emits:["refresh"],setup(x,{expose:R,emit:V}){const{user:d}=se(),N=V,U=v(),r=v({username:"",email:"",password:"",phone:"",nick_name:""}),M=v([]),F=v(!1),q=v([]),L=v([]),w=v([]),z=v([]),g=ve(()=>r.value.id==="f0dd8f71-e4ee-11ee-8c84-a8a1595801ab");function f(o){return!!(g.value&&["ADMIN","WORKSPACE_MANAGE","USER"].includes(o.role_id))}async function S(){var o;try{const a=await re.getWorkspaceRoleList(F);L.value=[{path:"role_id",label:i("views.role.member.role"),rules:[{required:!0,message:`${i("common.selectPlaceholder")}${i("views.role.member.role")}`}],selectProps:{options:((o=a.data)==null?void 0:o.map(u=>({label:u.name,value:u.id})))||[],placeholder:`${i("common.selectPlaceholder")}${i("views.role.member.role")}`,multiple:!1}}],w.value=a.data.filter(u=>u.type===fe.ADMIN)}catch(a){console.error(a)}}async function B(){var o;try{const a=await re.getWorkspaceList(F);z.value=[{path:"workspace_ids",label:i("views.role.member.workspace"),hidden:u=>w.value.find(h=>h.id===u.role_id),rules:[{validator:(u,h,C)=>{var O;const _=(O=u.field)==null?void 0:O.match(/\[(\d+)\]/);!w.value.some(k=>k.id===M.value[parseInt((_==null?void 0:_[1])??"",10)].role_id)&&(!h||h.length===0)?C(new Error(`${i("common.selectPlaceholder")}${i("views.role.member.workspace")}`)):C()},trigger:"blur"}],selectProps:{options:((o=a.data)==null?void 0:o.map(u=>({label:u.name,value:u.id,disabledFunction:h=>g.value&&["WORKSPACE_MANAGE","USER"].includes(h.role_id)&&u.id==="default"})))||[],placeholder:`${i("common.selectPlaceholder")}${i("views.role.member.workspace")}`,clearableFunction:u=>!(g.value&&["WORKSPACE_MANAGE","USER"].includes(u.role_id))}}]}catch(a){console.error(a)}}ge(async()=>{(d.isEE()||d.isPE())&&(await S(),d.isEE()&&await B(),q.value=[...L.value,...z.value]),M.value=[{role_id:"",workspace_ids:[]}]});const j=ne({username:[{required:!0,message:i("views.login.loginForm.username.requiredMessage"),trigger:"blur"},{min:4,max:20,message:i("views.login.loginForm.username.lengthMessage"),trigger:"blur"}],nick_name:[{required:!0,message:i("views.userManage.userForm.nick_name.placeholder"),trigger:"blur"},{min:1,max:20,message:i("views.userManage.userForm.nick_name.lengthMessage"),trigger:"blur"}],email:[{required:!0,message:i("views.login.loginForm.email.requiredMessage"),trigger:"blur"}],password:[{required:!0,message:i("views.login.loginForm.password.requiredMessage"),trigger:"blur"},{min:6,max:20,message:i("views.login.loginForm.password.lengthMessage"),trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:i("views.userManage.userForm.phone.invalidMessage"),trigger:"blur"}]}),E=v(!1),e=v(!1),t=v(!1);ie(E,o=>{var a;o||(r.value={username:"",email:"",password:"",phone:"",nick_name:""},t.value=!1,M.value=[{role_id:"",workspace_ids:[]}],(a=U.value)==null||a.clearValidate())});const P=o=>{var a;o?(r.value.id=o.id,r.value.username=o.username,r.value.email=o.email,r.value.password=o.password,r.value.phone=o.phone,r.value.nick_name=o.nick_name,M.value=(a=o.role_setting)==null?void 0:a.map(u=>({...u,workspace_ids:u.workspace_ids.includes("None")?[]:u.workspace_ids})),t.value=!0):G.getSystemDefaultPassword().then(u=>{r.value.password=u.data.password}),c.value&&c.value.resetValidation(),E.value=!0},c=v(),W=async o=>{o&&await o.validate(async(a,u)=>{var h;if(a){c.value&&await((h=c.value)==null?void 0:h.validate()),(d.isPE()||d.isEE())&&(M.value=M.value.map(_=>w.value.find(O=>O.id===_.role_id)?{..._,workspace_ids:["None"]}:d.isPE()?{..._,workspace_ids:["default"]}:_));const C={...r.value,role_setting:M.value};t.value?G.putUserManage(r.value.id,C,e).then(_=>d.profile(e).then(()=>_)).then(_=>{N("refresh"),Q(i("common.editSuccess")),E.value=!1}):G.postUserManage(C,e).then(_=>d.profile(e).then(()=>_)).then(_=>{N("refresh"),Q(i("common.createSuccess")),E.value=!1})}})};return R({open:P}),(o,a)=>{const u=m("el-input"),h=m("el-form-item"),C=m("el-form"),_=m("el-button"),H=m("el-drawer"),O=le("loading");return b(),$(H,{modelValue:E.value,"onUpdate:modelValue":a[8]||(a[8]=k=>E.value=k),size:"600"},{header:n(()=>[A("h4",null,y(x.title),1)]),footer:n(()=>[l(_,{onClick:a[6]||(a[6]=T(k=>E.value=!1,["prevent"]))},{default:n(()=>[I(y(o.$t("common.cancel")),1)]),_:1}),l(_,{type:"primary",onClick:a[7]||(a[7]=k=>W(U.value)),loading:e.value},{default:n(()=>[I(y(o.$t("common.save")),1)]),_:1},8,["loading"])]),default:n(()=>[A("h4",ke,y(o.$t("common.info")),1),l(C,{ref_key:"userFormRef",ref:U,model:r.value,rules:j,"label-position":"top","require-asterisk-position":"right",onSubmit:a[4]||(a[4]=T(()=>{},["prevent"])),"close-on-click-modal":!1,"close-on-press-escape":!1},{default:n(()=>[l(h,{prop:t.value?"":"username",label:o.$t("views.login.loginForm.username.label")},{default:n(()=>[l(u,{modelValue:r.value.username,"onUpdate:modelValue":a[0]||(a[0]=k=>r.value.username=k),placeholder:o.$t("views.login.loginForm.username.placeholder"),maxlength:"20","show-word-limit":"",disabled:t.value},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["prop","label"]),l(h,{label:o.$t("views.userManage.userForm.nick_name.label"),prop:"nick_name"},{default:n(()=>[l(u,{modelValue:r.value.nick_name,"onUpdate:modelValue":a[1]||(a[1]=k=>r.value.nick_name=k),placeholder:o.$t("views.userManage.userForm.nick_name.placeholder"),maxlength:"20","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(h,{label:o.$t("views.login.loginForm.email.label"),prop:"email"},{default:n(()=>[l(u,{type:"email",modelValue:r.value.email,"onUpdate:modelValue":a[2]||(a[2]=k=>r.value.email=k),placeholder:o.$t("views.login.loginForm.email.placeholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(h,{label:o.$t("views.userManage.userForm.phone.label"),prop:"phone"},{default:n(()=>[l(u,{modelValue:r.value.phone,"onUpdate:modelValue":a[3]||(a[3]=k=>r.value.phone=k),placeholder:o.$t("views.userManage.userForm.phone.placeholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),t.value?D("",!0):(b(),$(h,{key:0,label:"默认密码"},{default:n(()=>[A("span",null,y(r.value.password),1)]),_:1}))]),_:1},8,["model","rules"]),p(d).isEE()||p(d).isPE()?(b(),Y("h4",$e,y(o.$t("views.userManage.roleSetting")),1)):D("",!0),p(d).isEE()||p(d).isPE()?ae((b(),$(he,{key:1,ref_key:"memberFormContentRef",ref:c,models:q.value,form:M.value,"onUpdate:form":a[5]||(a[5]=k=>M.value=k),keepOneLine:"",addText:o.$t("views.userManage.addRole"),deleteButtonDisabled:f},null,8,["models","form","addText"])),[[O,F.value]]):D("",!0)]),_:1},8,["modelValue"])}}}),ye={class:"dialog-footer"},Ve=oe({__name:"UserPwdDialog",emits:["refresh"],setup(x,{expose:R,emit:V}){const d=V,{user:N}=se(),U=v(),r=v({password:"",re_password:""}),M=ne({password:[{required:!0,message:i("views.login.loginForm.new_password.requiredMessage"),trigger:"blur"},{min:6,max:20,message:i("views.login.loginForm.password.lengthMessage"),trigger:"blur"}],re_password:[{required:!0,message:i("views.login.loginForm.re_password.requiredMessage"),trigger:"blur"},{min:6,max:20,message:i("views.login.loginForm.password.lengthMessage"),trigger:"blur"},{validator:(g,f,S)=>{U.value.password!=U.value.re_password?S(new Error(i("views.login.loginForm.re_password.validatorMessage"))):S()},trigger:"blur"}]}),F=v(!1),q=v(!1),L=v("");ie(F,g=>{g||(r.value={password:"",re_password:""})});const w=g=>{var f;L.value=g.id,F.value=!0,(f=U.value)==null||f.clearValidate()},z=async g=>{g&&await g.validate((f,S)=>{f&&G.putUserManagePassword(L.value,r.value,q).then(B=>{d("refresh"),N.profile(),Q(i("views.userManage.tip.updatePwdSuccess")),F.value=!1})})};return R({open:w}),(g,f)=>{const S=m("el-input"),B=m("el-form-item"),j=m("el-form"),E=m("el-button"),e=m("el-dialog");return b(),$(e,{title:g.$t("views.userManage.setting.updatePwd"),modelValue:F.value,"onUpdate:modelValue":f[5]||(f[5]=t=>F.value=t)},{footer:n(()=>[A("span",ye,[l(E,{onClick:f[3]||(f[3]=T(t=>F.value=!1,["prevent"]))},{default:n(()=>[I(y(g.$t("common.cancel")),1)]),_:1}),l(E,{type:"primary",onClick:f[4]||(f[4]=t=>z(U.value)),loading:q.value},{default:n(()=>[I(y(g.$t("common.save")),1)]),_:1},8,["loading"])])]),default:n(()=>[l(j,{ref_key:"userFormRef",ref:U,model:r.value,rules:M,"label-position":"top","require-asterisk-position":"right",onSubmit:f[2]||(f[2]=T(()=>{},["prevent"])),"close-on-click-modal":!1,"close-on-press-escape":!1},{default:n(()=>[l(B,{label:g.$t("views.login.loginForm.new_password.label"),prop:"password"},{default:n(()=>[l(S,{type:"password",modelValue:r.value.password,"onUpdate:modelValue":f[0]||(f[0]=t=>r.value.password=t),placeholder:g.$t("views.login.loginForm.new_password.placeholder"),"show-password":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(B,{label:g.$t("views.login.loginForm.re_password.label"),prop:"re_password"},{default:n(()=>[l(S,{type:"password",modelValue:r.value.re_password,"onUpdate:modelValue":f[1]||(f[1]=t=>r.value.re_password=t),placeholder:g.$t("views.login.loginForm.re_password.placeholder"),"show-password":""},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])}}}),Fe={class:"p-16-24"},Ee={class:"mb-16"},Ue={class:"flex-between mb-16"},Ce={class:"flex-between complex-search"},Ae={key:0,class:"flex align-center"},Pe={class:"color-text-primary"},Re={key:1,class:"flex align-center"},Se={class:"color-text-primary"},De={class:"mr-8"},Ie={class:"mr-8"},qe=oe({__name:"index",setup(x){const{user:R}=se(),V=v("username"),d=v({username:"",nick_name:"",email:"",is_active:null,source:""}),N=v(),U=v(),r=v(!1),M=ne({current_page:1,page_size:20,total:0}),F=v([]),q=()=>{d.value={username:"",nick_name:"",email:"",is_active:null}};function L(){M.current_page=1,w()}function w(){const e={},t=d.value[V.value];return t!=null&&t!==""&&(e[V.value]=t),G.getUserManage(M,e,r).then(P=>{F.value=P.data.records.map(c=>({...c,role_workspace:Object.entries(c.role_workspace??{}).map(([W,o])=>({role:W,workspace:(o==null?void 0:o[0])==="None"?"-":o==null?void 0:o.join(", ")}))})),M.total=P.data.total})}async function z(e){const t={is_active:!e.is_active},P=t.is_active?i("common.status.enableSuccess"):i("common.status.disableSuccess");await G.putUserManage(e.id,t,r).then(c=>(w(),Q(P),!0)).catch(()=>!1)}const g=v("");function f(e){g.value=i("views.userManage.editUser"),N.value.open(e)}function S(){g.value=i("views.userManage.createUser"),N.value.open()}function B(e){we(`${i("views.userManage.delete.confirmTitle")}${e.nick_name} ?`,i("views.userManage.delete.confirmMessage"),{confirmButtonText:i("common.confirm"),confirmButtonClass:"danger"}).then(()=>{r.value=!0,G.delUserManage(e.id,r).then(()=>{Q(i("common.deleteSuccess")),w()})}).catch(()=>{})}function j(e){U.value.open(e)}function E(){w()}return be(()=>{w()}),(e,t)=>{const P=m("el-button"),c=m("el-option"),W=m("el-select"),o=m("el-input"),a=m("el-table-column"),u=m("SuccessFilled"),h=m("el-icon"),C=m("AppIcon"),_=m("TagGroup"),H=m("el-table"),O=m("el-popover"),k=m("el-switch"),ue=m("el-divider"),ee=m("el-tooltip"),de=m("app-table"),me=m("el-card"),ce=le("hasPermission"),pe=le("loading");return b(),Y("div",Fe,[A("h2",Ee,y(e.$t("views.userManage.title")),1),l(me,{class:"main-calc-height"},{default:n(()=>[A("div",Ue,[ae((b(),$(P,{type:"primary",onClick:S},{default:n(()=>[I(y(e.$t("views.userManage.createUser")),1)]),_:1})),[[ce,[p(J).ADMIN,p(Z).USER_CREATE]]]),A("div",Ce,[l(W,{class:"complex-search__left",modelValue:V.value,"onUpdate:modelValue":t[0]||(t[0]=s=>V.value=s),style:{width:"120px"},onChange:q},{default:n(()=>[l(c,{label:e.$t("views.login.loginForm.username.label"),value:"username"},null,8,["label"]),l(c,{label:e.$t("views.userManage.userForm.nick_name.label"),value:"nick_name"},null,8,["label"]),l(c,{label:e.$t("views.login.loginForm.email.label"),value:"email"},null,8,["label"]),l(c,{label:e.$t("common.status.label"),value:"is_active"},null,8,["label"]),p(R).isEE()||p(R).isPE()?(b(),$(c,{key:0,label:e.$t("views.userManage.source.label"),value:"source"},null,8,["label"])):D("",!0)]),_:1},8,["modelValue"]),V.value==="username"?(b(),$(o,{key:0,modelValue:d.value.username,"onUpdate:modelValue":t[1]||(t[1]=s=>d.value.username=s),onChange:w,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},null,8,["modelValue","placeholder"])):V.value==="nick_name"?(b(),$(o,{key:1,modelValue:d.value.nick_name,"onUpdate:modelValue":t[2]||(t[2]=s=>d.value.nick_name=s),onChange:w,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},null,8,["modelValue","placeholder"])):V.value==="email"?(b(),$(o,{key:2,modelValue:d.value.email,"onUpdate:modelValue":t[3]||(t[3]=s=>d.value.email=s),onChange:w,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},null,8,["modelValue","placeholder"])):V.value==="is_active"?(b(),$(W,{key:3,modelValue:d.value.is_active,"onUpdate:modelValue":t[4]||(t[4]=s=>d.value.is_active=s),onChange:w,clearable:"",style:{width:"220px"}},{default:n(()=>[l(c,{label:e.$t("common.status.enabled"),value:!0},null,8,["label"]),l(c,{label:e.$t("common.status.disabled"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])):V.value==="source"?(b(),$(W,{key:4,modelValue:d.value.source,"onUpdate:modelValue":t[5]||(t[5]=s=>d.value.source=s),onChange:w,style:{width:"220px"},clearable:"",placeholder:e.$t("common.inputPlaceholder")},{default:n(()=>[l(c,{label:e.$t("views.userManage.source.local"),value:"LOCAL"},null,8,["label"]),l(c,{label:"CAS",value:"CAS"}),l(c,{label:"LDAP",value:"LDAP"}),l(c,{label:"OIDC",value:"OIDC"}),l(c,{label:"OAuth2",value:"OAuth2"}),l(c,{label:e.$t("views.userManage.source.wecom"),value:"wecom"},null,8,["label"]),l(c,{label:e.$t("views.userManage.source.lark"),value:"lark"},null,8,["label"]),l(c,{label:e.$t("views.userManage.source.dingtalk"),value:"dingtalk"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])):D("",!0)])]),ae((b(),$(de,{class:"mt-16",data:F.value,"pagination-config":M,onSizeChange:L,onChangePage:w,maxTableHeight:280},{default:n(()=>[l(a,{prop:"nick_name",label:e.$t("views.userManage.userForm.nick_name.label"),"min-width":"180","show-overflow-tooltip":""},null,8,["label"]),l(a,{prop:"username","min-width":"180","show-overflow-tooltip":"",label:e.$t("views.login.loginForm.username.label")},null,8,["label"]),l(a,{width:"100",prop:"is_active",label:e.$t("common.status.label")},{default:n(({row:s})=>[s.is_active?(b(),Y("div",Ae,[l(h,{class:"color-success mr-8",style:{"font-size":"16px"}},{default:n(()=>[l(u)]),_:1}),A("span",Pe,y(e.$t("common.status.enabled")),1)])):(b(),Y("div",Re,[l(C,{iconName:"app-disabled",class:"color-secondary mr-8"}),A("span",Se,y(e.$t("common.status.disabled")),1)]))]),_:1},8,["label"]),l(a,{prop:"email",label:e.$t("views.login.loginForm.email.label"),"show-overflow-tooltip":"","min-width":"180"},{default:n(({row:s})=>[I(y(s.email||"-"),1)]),_:1},8,["label"]),l(a,{prop:"phone",width:"120",label:e.$t("views.userManage.userForm.phone.label")},{default:n(({row:s})=>[I(y(s.phone||"-"),1)]),_:1},8,["label"]),p(R).isEE()||p(R).isPE()?(b(),$(a,{key:0,prop:"role_name",label:e.$t("views.role.member.role"),width:"210"},{default:n(({row:s})=>[l(O,{width:400},{reference:n(()=>[l(_,{class:"cursor",style:{width:"fit-content"},tags:s.role_name,tooltipDisabled:""},null,8,["tags"])]),default:n(()=>[l(H,{data:s.role_workspace},{default:n(()=>[l(a,{prop:"role",label:e.$t("views.role.member.role")},null,8,["label"]),l(a,{prop:"workspace",label:e.$t("views.workspace.title")},null,8,["label"])]),_:1},8,["data"])]),_:2},1024)]),_:1},8,["label"])):D("",!0),l(a,{prop:"source",width:"100",label:e.$t("views.userManage.source.label")},{default:n(({row:s})=>[I(y(s.source==="LOCAL"?e.$t("views.userManage.source.local"):s.source==="wecom"?e.$t("views.userManage.source.wecom"):s.source==="lark"?e.$t("views.userManage.source.lark"):s.source==="dingtalk"?e.$t("views.userManage.source.dingtalk"):s.source==="OAUTH2"||s.source==="OAuth2"?"OAuth2":s.source),1)]),_:1},8,["label"]),l(a,{label:e.$t("common.createTime"),width:"180"},{default:n(({row:s})=>[I(y(p(_e)(s.create_time)),1)]),_:1},8,["label"]),l(a,{label:e.$t("common.operation"),width:"160",align:"left",fixed:"right"},{default:n(({row:s})=>{var te;return[A("span",{onClick:t[6]||(t[6]=T(()=>{},["stop"]))},[p(X)([p(J).ADMIN,p(Z).USER_EDIT],"OR")?(b(),$(k,{key:0,disabled:s.role==="ADMIN"||s.id===((te=p(R).userInfo)==null?void 0:te.id),size:"small",modelValue:s.is_active,"onUpdate:modelValue":K=>s.is_active=K,"before-change":()=>z(s)},null,8,["disabled","modelValue","onUpdate:modelValue","before-change"])):D("",!0)]),l(ue,{direction:"vertical"}),l(ee,{effect:"dark",content:e.$t("common.edit"),placement:"top"},{default:n(()=>[A("span",De,[p(X)([p(J).ADMIN,p(Z).USER_EDIT],"OR")?(b(),$(P,{key:0,type:"primary",text:"",onClick:T(K=>f(s),["stop"]),title:e.$t("common.edit")},{default:n(()=>[l(C,{iconName:"app-edit"})]),_:1},8,["onClick","title"])):D("",!0)])]),_:2},1032,["content"]),l(ee,{effect:"dark",content:e.$t("views.userManage.setting.updatePwd"),placement:"top"},{default:n(()=>[A("span",Ie,[p(X)([p(J).ADMIN,p(Z).USER_EDIT],"OR")?(b(),$(P,{key:0,type:"primary",text:"",onClick:T(K=>j(s),["stop"]),title:e.$t("views.userManage.setting.updatePwd")},{default:n(()=>[l(C,{iconName:"app-key"})]),_:1},8,["onClick","title"])):D("",!0)])]),_:2},1032,["content"]),l(ee,{effect:"dark",content:e.$t("common.delete"),placement:"top"},{default:n(()=>{var K;return[p(X)([p(J).ADMIN,p(Z).USER_DELETE],"OR")?(b(),$(P,{key:0,disabled:s.role==="ADMIN"||s.id===((K=p(R).userInfo)==null?void 0:K.id),type:"primary",text:"",onClick:T(Ne=>B(s),["stop"]),title:e.$t("common.delete")},{default:n(()=>[l(C,{iconName:"app-delete"})]),_:1},8,["disabled","onClick","title"])):D("",!0)]}),_:2},1032,["content"])]}),_:1},8,["label"])]),_:1},8,["data","pagination-config"])),[[pe,r.value]])]),_:1}),l(Me,{title:g.value,ref_key:"UserDrawerRef",ref:N,onRefresh:E},null,8,["title"]),l(Ve,{ref_key:"UserPwdDialogRef",ref:U,onRefresh:E},null,512)])}}});export{qe as default};
